# Docker Compose for Production with Traefik
#
# Required environment variables (in .env or shell):
#   QUIVR_DOMAIN       - Domain for Quivr API (e.g., quivr.ihre-schule.de)
#   DOCKER_IMAGE_TAG   - Docker image tag (default: latest)
#   DOCKER_REGISTRY    - Docker registry/user (e.g., yourusername)
#
# Optional:
#   FRONTEND_DOMAIN    - Domain for frontend (if different from API)
#
# Usage:
#   export QUIVR_DOMAIN=quivr.ihre-schule.de
#   export DOCKER_REGISTRY=yourdockerhubuser
#   docker compose -f docker-compose.production.yml up -d

services:
  backend-api:
    image: ${DOCKER_REGISTRY:-quivr}/quivr-backend:${DOCKER_IMAGE_TAG:-latest}
    env_file:
      - .env
    container_name: backend-api
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: [ "CMD", "curl", "http://localhost:5050/healthz" ]
    command: >
      /bin/bash -c "python -m uvicorn quivr_api.main:app --host 0.0.0.0 --log-level info --port 5050 --loop uvloop"
    restart: always
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.quivr-backend.rule=Host(`${QUIVR_DOMAIN}`)"
      - "traefik.http.routers.quivr-backend.entrypoints=websecure"
      - "traefik.http.routers.quivr-backend.tls.certresolver=myresolver"
      - "traefik.http.services.quivr-backend.loadbalancer.server.port=5050"
    networks:
      - supabase_network_secondbrain

  worker:
    image: ${DOCKER_REGISTRY:-quivr}/quivr-backend:${DOCKER_IMAGE_TAG:-latest}
    env_file:
      - .env
    container_name: worker
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: >
      /bin/bash -c "python -m celery -A quivr_worker.celery_worker worker -l info -c 3"
    restart: always
    depends_on:
      - redis
    networks:
      - supabase_network_secondbrain

  notifier:
    image: ${DOCKER_REGISTRY:-quivr}/quivr-backend:${DOCKER_IMAGE_TAG:-latest}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    env_file:
      - .env
    container_name: notifier
    command: >
      /bin/bash -c "python /app/worker/quivr_worker/celery_monitor.py"
    restart: always
    depends_on:
      - redis
      - worker
    networks:
      - supabase_network_secondbrain

  beat:
    image: ${DOCKER_REGISTRY:-quivr}/quivr-backend:${DOCKER_IMAGE_TAG:-latest}
    env_file:
      - .env
    container_name: beat
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: >
      /bin/bash -c "python -m celery -A quivr_worker.celery_worker beat -l info"
    restart: always
    depends_on:
      - redis
    networks:
      - supabase_network_secondbrain

  flower:
    image: ${DOCKER_REGISTRY:-quivr}/quivr-backend:${DOCKER_IMAGE_TAG:-latest}
    env_file:
      - .env
    container_name: flower
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: >
      /bin/bash -c "python -m celery -A quivr_worker.celery_worker flower -l info --port=5555"
    restart: always
    depends_on:
      - redis
      - worker
      - beat
    networks:
      - supabase_network_secondbrain

  redis:
    image: redis:latest
    container_name: redis
    restart: always
    networks:
      - supabase_network_secondbrain

networks:
  supabase_network_secondbrain:
    external: true
